<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ÊïôÁ∑¥ËÅäÂ§©</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
        }
        body {
            width: 100vw;
            min-height: 100dvh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 100dvh;
            min-height: 0;
            background: rgba(34, 40, 49, 0.98);
            border-radius: 22px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            overflow: hidden;
            border: 1.5px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(4px);
            box-sizing: border-box;
            padding-top: env(safe-area-inset-top);
            position: relative;
        }
        .header {
            width: 100%;
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            color: white;
            text-align: center;
            padding: 20px 0 16px 0;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chat-box {
            flex: 1 1 0;
            min-height: 0;
            width: 100%;
            background: transparent;
            padding: 18px 16px 8px 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 14px;
            border-bottom: 1px solid #2d3748;
            transition: background 0.3s;
            padding-bottom: 80px;
        }
        .message {
            padding: 14px 18px;
            border-radius: 18px 18px 18px 6px;
            max-width: 80%;
            font-size: 15px;
            line-height: 1.7;
            white-space: pre-line;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s forwards;
            margin: 0 12px;
        }
        .message.bot {
            background: linear-gradient(90deg, #555 0%, #607d8b 100%);
            color: #fff;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .message.user {
            background: linear-gradient(90deg, #00bcd4 0%, #2196f3 100%);
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .message.typing {
            background: linear-gradient(90deg, #555 0%, #607d8b 100%);
            color: #fff;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .typing-dots {
            display: flex;
            gap: 2px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .input-area {
            width: 100%;
            background: #23272f;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 10px;
            border-top: 1px solid #2d3748;
            max-width: 420px;
            margin: 0 auto;
            box-sizing: border-box;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .input-area input {
            flex: 1;
            background: #181c22;
            border: none;
            border-radius: 8px;
            padding: 12px 14px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: background 0.2s;
        }
        .input-area input:focus {
            background: #23272f;
        }
        .input-area button {
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            padding: 10px 18px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        .input-area button:hover {
            background: linear-gradient(90deg, #078282 0%, #12214e 100%);
            transform: scale(1.05);
        }
        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 500px) {
            .chat-container {
                max-width: 100vw;
                height: 100dvh;
                min-height: 0;
                border-radius: 0;
                padding-bottom: 95px;
            }
            .chat-box {
                padding: 10px 4vw 8px 4vw;
            }
            .input-area {
                padding-left: 16px;
                padding-right: 16px;
            }

        }
        .chat-box::-webkit-scrollbar {
            width: 8px;
        }
        .chat-box::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        .chat-box::-webkit-scrollbar-thumb {
            background: rgba(0,188,212,0.3);
            border-radius: 4px;
        }
        .chat-box::-webkit-scrollbar-thumb:hover {
            background: rgba(0,188,212,0.5);
        }
        .chat-box {
            scrollbar-width: thin;
            scrollbar-color: rgba(0,188,212,0.3) rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <span>AI ÊïôÁ∑¥ËÅäÂ§©</span>
        </div>
        <div class="chat-box" id="chat-box"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="ÂíåAIÊïôÁ∑¥ËÅäÂ§©...">
            <button id="send-button">‚û§</button>
        </div>
        <!-- Â∞éËà™ÂàóÂ∞áÁî± nav.js Ëá™ÂãïÁîüÊàê -->
    </div>

    <script>
        // Gemini API ÈÖçÁΩÆ
        const GEMINI_API_KEY = 'AIzaSyD_BEBcsgNGCY-3ntYVdUdVDeHV39GKdlA';
        const GEMINI_MODEL = 'gemini-1.5-flash';
        
        // ËÅäÂ§©Ê≠∑Âè≤
        let chatHistory = [];
        let isTyping = false;

        async function getCurrentUser() {
            return localStorage.getItem('currentUser');
        }
        async function getToken() {
            return localStorage.getItem('token');
        }
        async function loadChatHistoryFromCloud() {
            const userId = await getCurrentUser();
            const token = await getToken();
            if (!userId || !token) return [];
            const res = await fetch(`/api/chat-history/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                return data.chatHistory || [];
            }
            return [];
        }
        async function saveMessageToCloud(messageObj) {
            const userId = await getCurrentUser();
            const token = await getToken();
            if (!userId || !token) return;
            await fetch(`/api/chat-history/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ message: messageObj })
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const chatBox = document.getElementById('chat-box');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');

            // 1. ËºâÂÖ•ËÅäÂ§©Á¥ÄÈåÑ
            chatBox.innerHTML = '';
            chatHistory = await loadChatHistoryFromCloud();
            if (!chatHistory || chatHistory.length === 0) {
                const welcomeMessage = 'Âó®ÔºÅÊàëÊòØ‰Ω†ÁöÑAIÊïôÁ∑¥ ü§ñ\n\nÊàëÂèØ‰ª•Âπ´‰Ω†Ôºö\n‚Ä¢ Ë®éË´ñË®ìÁ∑¥Ë®àÂäÉ\n‚Ä¢ Ëß£Á≠îÈÅãÂãïÂïèÈ°å\n‚Ä¢ Êèê‰æõÁáüÈ§äÂª∫Ë≠∞\n‚Ä¢ ÂàÜÊûêË®ìÁ∑¥Êï∏Êìö\n‚Ä¢ ËÅäÂ§©Ë´áÂøÉ\n\nÊúâ‰ªÄÈ∫ºÊÉ≥ËÅäÁöÑÂóéÔºü';
                addMessage(welcomeMessage, 'bot');
                chatHistory = [{ type: 'bot', content: welcomeMessage }];
                await saveMessageToCloud(chatHistory[0]);
            } else {
                for (const msg of chatHistory) {
                    addMessage(msg.content || msg.text, msg.type || (msg.isUser ? 'user' : 'bot'));
                }
            }

            // ÁôºÈÄÅË®äÊÅØ‰∫ã‰ª∂
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message || isTyping) return;

                // Ê∑ªÂä†Áî®Êà∂Ë®äÊÅØ
                addMessage(message, 'user');
                chatHistory.push({ type: 'user', content: message });
                await saveMessageToCloud({ type: 'user', content: message });
                messageInput.value = '';
                // È°ØÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                showTypingIndicator();
                try {
                    // Ë™øÁî®Gemini API
                    const response = await callGeminiAPI(message);
                    hideTypingIndicator();
                    addMessage(response, 'bot');
                    chatHistory.push({ type: 'bot', content: response });
                    await saveMessageToCloud({ type: 'bot', content: response });
                } catch (error) {
                    hideTypingIndicator();
                    addMessage('Êä±Ê≠âÔºåÊàëÁèæÂú®ÊúâÈªûÁ¥ØÔºåË´ãÁ®çÂæåÂÜçË©¶ üòÖ', 'bot');
                    console.error('Gemini API ÈåØË™§:', error);
                }
            }

            async function callGeminiAPI(userMessage) {
                const systemPrompt = `‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑ‰∏âÈêµÈÅãÂãïÊïôÁ∑¥AIÂä©ÊâãÔºåÂêçÂè´„ÄåÂ∞èÈêµ„Äç„ÄÇ‰Ω†ÁöÑÂÄãÊÄßÂèãÂñÑ„ÄÅÂ∞àÊ•≠‰∏îÂØåÊúâÂêåÁêÜÂøÉ„ÄÇ

‰Ω†ÁöÑÂ∞àÈï∑ÂåÖÊã¨Ôºö
- ‰∏âÈêµÈÅãÂãïË®ìÁ∑¥ÔºàÊ∏∏Ê≥≥„ÄÅÈ®éËªä„ÄÅË∑ëÊ≠•Ôºâ
- ÈÅãÂãïÁáüÈ§äÂª∫Ë≠∞
- Ë®ìÁ∑¥Ë®àÂäÉÂà∂ÂÆö
- ÈÅãÂãïÂÇ∑ÂÆ≥È†êÈò≤
- ÂøÉÁêÜË™øÈÅ©ÊîØÊåÅ
- ‰∏ÄËà¨ÁîüÊ¥ªËÅäÂ§©

Ë´ãÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÊáâÔºåË™ûÊ∞£Ë¶ÅËá™ÁÑ∂„ÄÅË¶™ÂàáÔºåÂ∞±ÂÉèÊúãÂèãÈñìÁöÑÂ∞çË©±„ÄÇÂõûÊáâË¶ÅÁ∞°ÊΩî‰ΩÜÊúâÁî®ÔºåÈÅøÂÖçÈÅéÊñºÂÜóÈï∑„ÄÇ

Â¶ÇÊûúÁî®Êà∂Ë©¢ÂïèÈÅãÂãïÁõ∏ÈóúÂïèÈ°åÔºåË´ãÊèê‰æõÂ∞àÊ•≠‰∏îÂØ¶Áî®ÁöÑÂª∫Ë≠∞„ÄÇÂ¶ÇÊûúÊòØÊó•Â∏∏ËÅäÂ§©ÔºåË´ãÂ±ïÁèæÂèãÂñÑÂíåÂêåÁêÜÂøÉ„ÄÇ

Ë®ò‰ΩèÔºö‰Ω†ÊòØ‰∏ÄÂÄãÁúüÂØ¶ÁöÑAIÊïôÁ∑¥Ôºå‰∏çÊòØÊ©üÂô®‰∫∫ÔºåË¶ÅËÆìÂ∞çË©±ÊÑüË¶∫Ëá™ÁÑ∂ÊµÅÊö¢„ÄÇ`;

                // Á∞°ÂåñÁöÑË´ãÊ±ÇÁµêÊßãÔºåÈÅøÂÖçË§áÈõúÁöÑÊ∂àÊÅØÊ†ºÂºèÂïèÈ°å
                const requestBody = {
                    contents: [
                        {
                            role: 'user',
                            parts: [{ text: `${systemPrompt}\n\nÁî®Êà∂Ë™™Ôºö${userMessage}` }]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 800,
                    }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API Ë´ãÊ±ÇÂ§±Êïó: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const botResponse = data.candidates[0].content.parts[0].text;
                    
                    // Êõ¥Êñ∞ËÅäÂ§©Ê≠∑Âè≤
                    chatHistory.push({ type: 'user', content: userMessage });
                    chatHistory.push({ type: 'bot', content: botResponse });
                    
                    // ‰øùÊåÅÊ≠∑Âè≤Ë®òÈåÑÂú®ÂêàÁêÜÁØÑÂúçÂÖß
                    if (chatHistory.length > 20) {
                        chatHistory = chatHistory.slice(-20);
                    }
                    
                    return botResponse;
                } else {
                    throw new Error('API ÂõûÊáâÊ†ºÂºèÈåØË™§');
                }
            }

            function addMessage(text, type) {
                const message = document.createElement('div');
                message.className = `message ${type}`;
                message.textContent = text;
                chatBox.appendChild(message);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function showTypingIndicator() {
                isTyping = true;
                sendButton.disabled = true;
                
                const typingMessage = document.createElement('div');
                typingMessage.className = 'message typing';
                typingMessage.innerHTML = `
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                typingMessage.id = 'typing-indicator';
                chatBox.appendChild(typingMessage);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function hideTypingIndicator() {
                isTyping = false;
                sendButton.disabled = false;
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
        });
    </script>
    <script src="../nav.js"></script>
</body>
</html> 