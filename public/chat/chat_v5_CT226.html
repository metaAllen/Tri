<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∑ö‰∏äË™≤Ë°®_226</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            position: relative;
        }

        /* ËÉåÊôØÂãïÁï´ÊïàÊûú */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 188, 212, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(33, 150, 243, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(156, 39, 176, 0.05) 0%, transparent 50%);
            animation: backgroundFloat 25s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundFloat {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg) scale(1); 
                opacity: 0.8;
            }
            25% { 
                transform: translateY(-15px) rotate(0.5deg) scale(1.02); 
                opacity: 1;
            }
            50% { 
                transform: translateY(10px) rotate(-0.5deg) scale(0.98); 
                opacity: 0.9;
            }
            75% { 
                transform: translateY(-5px) rotate(0.3deg) scale(1.01); 
                opacity: 0.95;
            }
        }
        body {
            width: 100vw;
            min-height: 100dvh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 100dvh;
            min-height: 0;
            background: rgba(34, 40, 49, 0.98);
            border-radius: 22px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            overflow: hidden;
            border: 1.5px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(4px);
            box-sizing: border-box;
            padding-top: env(safe-area-inset-top);
            position: relative;
        }
        .header {
            width: 100%;
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            color: white;
            text-align: center;
            padding: 20px 0 16px 0;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .chat-box {
            flex: 1 1 0;
            min-height: 0;
            width: 100%;
            background: transparent;
            padding: 24px 16px 24px 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: background 0.3s;
            padding-bottom: 80px;
            box-sizing: border-box;
            position: relative;
        }
        
        .chat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        .message {
            padding: 16px 20px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.6;
            margin: 0 12px 16px 12px;
            word-break: break-word;
            letter-spacing: 0.02em;
            max-width: 66.67%;
            white-space: pre-line;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            animation: messageSlideIn 0.8s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        .message.bot {
            background: linear-gradient(135deg, #686e6e 0%, #4b6b7c 100%);
            color: #e3f6ff;
            align-self: flex-start;
            border-radius: 20px 20px 20px 8px;
            font-weight: 400;
            text-align: left;
            box-shadow: 0 6px 20px rgba(14,110,253,0.10);
            border: 1px solid rgba(255,255,255,0.08);
            margin-right: auto;
            margin-left: 12px;
            animation: messageSlideInLeft 0.8s ease-out;
        }
        
        @keyframes messageSlideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .message.bot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }
        .message.user {
            background: linear-gradient(135deg, #59e3f8 0%, #92eef1 100%);
            color: #000000;
            align-self: flex-end;
            border-radius: 20px 20px 8px 20px;
            font-weight: 400;
            text-align: left;
            box-shadow: 0 6px 20px rgba(14,110,253,0.10);
            border: 1px solid rgba(255,255,255,0.15);
            margin-left: auto;
            margin-right: 12px;
            animation: messageSlideInRight 0.8s ease-out;
        }
        
        @keyframes messageSlideInRight {
            from {
                opacity: 0;
                transform: translateX(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .message.user::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }
        .message.typing {
            background: linear-gradient(135deg, #686e6e 0%, #4b6b7c 100%);
            color: #e3f6ff;
            align-self: flex-start;
            border-radius: 20px 20px 20px 8px;
            display: flex;
            align-items: center;
            min-height: 40px;
            height: 40px;
            max-width: 90px;
            width: fit-content;
            padding: 0 20px;
            margin: 0 12px 16px 12px;
            box-shadow: 0 6px 20px rgba(14,110,253,0.10);
            border: 1px solid rgba(255,255,255,0.08);
            margin-right: auto;
            margin-left: 12px;
            animation: messageSlideInLeft 0.8s ease-out;
        }
        .typing-dots {
            display: flex;
            align-items: center;
            height: 100%;
            gap: 4px;
        }
        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e3f6ff;
            opacity: 0.8;
            animation: typing-bounce 1.4s infinite both;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing-bounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.8; }
            40% { transform: translateY(-8px); opacity: 1; }
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .button-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 0;
            margin: 0 auto 8px auto;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }
        .button-container button, .button-row button {
            width: 100%;
            min-width: 0;
            height: 120px;
            padding: 0;
            background: linear-gradient(135deg, #003d4d 0%, #3ab1b6 100%);
            border: none;
            font-size: 18px;
            cursor: pointer;
            border-radius: 16px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,188,212,0.10);
            transition: background 0.3s, transform 0.2s, box-shadow 0.2s;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            outline: none;
        }
        .button-container button:hover, .button-row button:hover, .button-container button:active, .button-row button:active {
            background: linear-gradient(135deg, #3ab1b6 0%, #003d4d 100%);
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 4px 16px rgba(0,188,212,0.18);
        }
        .button-container button img, .button-row button img {
            width: 44px !important;
            height: 44px !important;
            margin: 0 auto 6px auto;
            display: block;
            object-fit: contain;
            max-width: 60%;
            max-height: 60%;
        }
        .button-row {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 6px;
            padding: 0;
            margin: 0 auto 0 auto;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }
        .button-row button {
            flex: 1 1 0;
            min-width: 0;
            width: 100%;
            margin: 0;
        }
        .input-area {
            position: fixed;
            bottom: 90px;
            left: 0;
            right: 0;
            z-index: 999;
            width: 100%;
            max-width: 100%;
            margin: 0;
            border-radius: 0;
            background: #23272f;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 10px;
            border-top: 1px solid #2d3748;
            box-sizing: border-box;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .input-area input {
            flex: 1;
            background: #181c22;
            border: none;
            border-radius: 16px;
            padding: 16px 18px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: background 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .input-area input:focus {
            background: #23272f;
        }
        .input-area button {
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            padding: 12px 22px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,188,212,0.10);
        }
        .input-area button:hover {
            background: linear-gradient(90deg, #078282 0%, #12214e 100%);
            transform: scale(1.05);
        }
        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 500px) {
            .chat-container {
                max-width: 100vw;
                height: 100dvh;
                min-height: 0;
                border-radius: 0;
                padding-bottom: 20px;
            }
            .chat-box {
                padding: 18px 4vw 8px 4vw;
            }
            .input-area {
                position: fixed;
                bottom: 60px;
                left: 0;
                right: 0;
                z-index: 999;
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
            .button-container, .button-row {
                max-width: 100vw;
                padding-left: 2vw;
                padding-right: 2vw;
                gap: 6px;
            }
            .button-container button, .button-row button {
                height: 90px;
                font-size: 16px;
            }
            .button-container button img, .button-row button img {
                width: 32px !important;
                height: 32px !important;
                margin: 0 auto 4px auto;
                max-width: 60%;
                max-height: 60%;
            }


            .input-area {
                margin-bottom: 40px;
            }
            #quick-buttons {
                margin-bottom: 100px;
            }
        }
        /* Ëá™ÂÆöÁæ©ÊªæÂãïÊ¢ùÊ®£Âºè */
        .chat-box::-webkit-scrollbar {
            width: 6px;
        }
        .chat-box::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.03);
            border-radius: 3px;
        }
        .chat-box::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(0,188,212,0.4), rgba(33,150,243,0.4));
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chat-box::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(0,188,212,0.6), rgba(33,150,243,0.6));
        }
        /* Firefox ÊªæÂãïÊ¢ùÊ®£Âºè */
        .chat-box {
            scrollbar-width: thin;
            scrollbar-color: rgba(0,188,212,0.4) rgba(255,255,255,0.03);
        }
        /* Âø´Êç∑Ôºö‰ªäÊó•/Êú¨ÈÄ±Ë™≤Ë°® - ÂÖ©Ê†º‰∏¶ÊéíÂç°ÁâáÈ¢®Ê†º */
        .button-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 0 12px;
            box-sizing: border-box;
        }
        .button-container button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 110px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(0,188,212,0.14) 0%, rgba(33,150,243,0.16) 100%);
            border: 1px solid rgba(255,255,255,0.12);
            color: #fff;
            box-shadow: 0 4px 14px rgba(0,0,0,0.18);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.25s ease;
            outline: none;
            overflow: hidden; /* Á¢∫‰øùÂúìËßí‰∏çË¢´Â≠êÂÖÉÁ¥†Á†¥Â£û */
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
            -webkit-tap-highlight-color: transparent;
            will-change: transform, box-shadow, background;
        }
        .button-container button:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.24);
            background: linear-gradient(135deg, rgba(0,188,212,0.22) 0%, rgba(33,150,243,0.24) 100%);
        }
        .button-container button:focus,
        .button-container button:focus-visible,
        .button-container button:hover {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,188,212,0.35) inset, 0 8px 20px rgba(0,0,0,0.24);
            border-radius: 14px; /* ÊòéÁ¢∫ÊåáÂÆöÈÅøÂÖçÁÄèË¶ΩÂô® outline ÈÄ†ÊàêË¶ñË¶∫‰∏äÁöÑÁõ¥Ëßí */
        }
        .button-container button img {
            width: 56px !important;
            height: 56px !important;
            border-radius: 12px; /* ÂúìËßíÂúñÁâáÔºåÈÅøÂÖçË¶ñË¶∫ÈåØË¶∫‰ª•ÁÇ∫ÊåâÈàïÂúìËßíÊ∂àÂ§± */
            display: block;
            pointer-events: none; /* Èò≤Ê≠¢ÂúñÁâáÊçïÊçâ hoverÔºåÂ∞éËá¥Áà∂Â±§ÂúìËßíË¢´Ë¶ÜËìãÁöÑË¶ñË¶∫ÈåØË¶∫ */
        }
        .button-container button span {
            font-size: 14px;
            letter-spacing: 1px;
            font-weight: 600;
        }
        /* ÂèñÊ∂àÊ∏∏Ê≥≥/È®éËªä/Ë∑ëÊ≠•Âø´Êç∑ÈçµÔºåÊïÖÁßªÈô§Â∞çÊáâÊ®£Âºè */
        .toggle-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: -22px;
            position: relative;
            z-index: 10;
            pointer-events: none;
        }
        #toggle-buttons {
            background: linear-gradient(135deg, #12214e 0%, #078282 100%);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0,188,212,0.18), 0 2px 8px rgba(0,0,0,0.10);
            cursor: pointer;
            transition: background 0.2s, transform 0.3s, box-shadow 0.3s;
            outline: none;
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%) scale(1);
            z-index: 11;
            pointer-events: auto;
        }
        #toggle-buttons:hover {
            background: linear-gradient(135deg, #078282 0%, #12214e 100%);
            box-shadow: 0 8px 24px rgba(0,188,212,0.28), 0 2px 8px rgba(0,0,0,0.12);
            transform: translateX(-50%) scale(1.08);
        }
        #toggle-icon {
            display: inline-block;
            transition: transform 0.3s;
            font-size: 26px;
            color: #fff;
            line-height: 1;
        }
        #toggle-buttons.closed #toggle-icon {
            transform: rotate(180deg);
        }
        #quick-buttons {
            transition: max-height 0.5s cubic-bezier(.4,2,.6,1), opacity 0.4s, transform 0.4s;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 420px;
            opacity: 1;
            transform: translateY(0);
            margin-bottom: 160px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            padding-left: 0;
            padding-right: 0;
            white-space: normal;
        }
        .button-container, .button-row {
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            padding-left: 0;
            padding-right: 0;
        }

        #quick-buttons::-webkit-scrollbar {
            width: 0;
            height: 0;
            background: transparent;
        }
        #quick-buttons {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <span>AI Coach</span>
        </div>
        <div class="chat-box" id="chat-box"></div>
        <div class="toggle-container">
            <button id="toggle-buttons" aria-label="Èö±Ëóè/Â±ïÈñãÂø´Êç∑ÊåâÈàï">
                <span id="toggle-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7 10l5 5 5-5" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
            </button>
        </div>

        <div id="quick-buttons" style="transition:max-height 0.5s cubic-bezier(.4,2,.6,1),opacity 0.4s,transform 0.4s;overflow-y:auto;max-height:420px;opacity:1;transform:translateY(0);margin-bottom:160px;width:100%;max-width:400px;box-sizing:border-box;padding-left:0;padding-right:0;">
            <div class="button-container">
                <button id="daily-schedule-button">
                    <img src="../images/day.png" alt="‰ªäÊó•Ë™≤Ë°®" style="width:60px;height:60px;display:block;margin:0 auto 2px auto;" />
                    <span style="font-size:14px;">‰ªäÊó•Ë™≤Ë°®</span>
                </button>
                <button id="weekly-schedule-button">
                    <img src="../images/week.png" alt="Êú¨ÈÄ±Ë™≤Ë°®" style="width:60px;height:60px;display:block;margin:0 auto 2px auto;" />
                    <span style="font-size:14px;">Êú¨ÈÄ±Ë™≤Ë°®</span>
                </button>
            </div>
            <!-- ÁßªÈô§‰ªäÂ§©Ê∏∏‰∫Ü/È®é‰∫Ü/Ë∑ë‰∫ÜÁöÑÂø´Êç∑ÈçµÔºà‰æù‰ΩøÁî®ËÄÖË¶ÅÊ±ÇÔºâ -->
        </div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="‰Ω†‰ªäÂ§©ÈÅãÂãï‰∫ÜÂóé?">
            <button id="send-button">‚û§</button>
        </div>
        <!-- Â∞éËà™ÂàóÂ∞áÁî± nav.js Ëá™ÂãïÁîüÊàê -->
    </div>

    <script>
        function getUserKey(key) {
            const user = localStorage.getItem('currentUser');
            return user ? `${key}_${user}` : key;
        }
        function getUserData(key, fallback = null) {
            const val = localStorage.getItem(getUserKey(key));
            if (!val) return fallback;
            try { return JSON.parse(val); } catch { return fallback; }
        }
        function getUserSchedules() {
            return getUserData('schedules', []);
        }

        // ====== ÂèñÂæóÁõÆÂâçÈÄ±Êï∏ÔºàÊ≠£Á¢∫ÂÄíÊï∏ÈÇèËºØÔºâ ======
        function getCurrentWeekIndex() {
            const type = getUserData('selectedScheduleType', '');
            const distance = getUserData('selectedScheduleDistance', '');
            let raceDate = null, offsetDays = 236;
            if (type === 'Challenge Taiwan' && distance === '226') {
                raceDate = new Date(2026, 3, 25); // 4Êúà25Êó•
                offsetDays = 236;
            } else if ((type === 'Ironman' && distance === '113') || (type === 'LAVA ÂÆåË≥ΩÊ®ÇÂúí' && distance === '113') || (type === 'Challenge Taiwan' && distance === '113')) {
                if(type === 'Ironman') {
                    raceDate = new Date(2025, 10, 2); // 11Êúà2Êó•
                    offsetDays = 167;
                } else if(type === 'LAVA ÂÆåË≥ΩÊ®ÇÂúí') {
                    raceDate = new Date(2026, 2, 14); // 3Êúà14Êó•
                    offsetDays = 167;
                } else if(type === 'Challenge Taiwan') {
                    raceDate = new Date(2026, 3, 25); // 4Êúà25Êó•
                    offsetDays = 167;
                }
            }
            if (!raceDate) return 0;
            const startDate = new Date(raceDate.getTime() - offsetDays * 24 * 60 * 60 * 1000);
            const now = new Date();
            if (now < startDate) return 0;
            const daysSinceStart = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
            const schedules = getUserSchedules();
            let weekIdx = Math.floor(daysSinceStart / 7);
            if (weekIdx >= schedules.length) weekIdx = schedules.length - 1;
            return weekIdx;
        }

        function getTodayScheduleAuto() {
            const schedules = getUserSchedules();
            const weekIdx = getCurrentWeekIndex();
            const type = getUserData('selectedScheduleType', '');
            const distance = getUserData('selectedScheduleDistance', '');
            let raceDate = null, offsetDays = 236;
            if (type === 'Challenge Taiwan' && distance === '226') {
                raceDate = new Date(2026, 3, 25);
                offsetDays = 236;
            } else if ((type === 'Ironman' && distance === '113') || (type === 'LAVA ÂÆåË≥ΩÊ®ÇÂúí' && distance === '113') || (type === 'Challenge Taiwan' && distance === '113')) {
                if(type === 'Ironman') {
                    raceDate = new Date(2025, 10, 2);
                    offsetDays = 167;
                } else if(type === 'LAVA ÂÆåË≥ΩÊ®ÇÂúí') {
                    raceDate = new Date(2026, 2, 14);
                    offsetDays = 167;
                } else if(type === 'Challenge Taiwan') {
                    raceDate = new Date(2026, 3, 25);
                    offsetDays = 167;
                }
            }
            if (!raceDate) return 'Â∞öÊú™ÈÅ∏ÊìáË™≤Ë°®';
            const startDate = new Date(raceDate.getTime() - offsetDays * 24 * 60 * 60 * 1000);
            const now = new Date();
            if (now < startDate) {
                const days = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                return `Ë∑ùÈõ¢Ë™≤Ë°®ÈñãÂßãÈÇÑÊúâ ${days} Â§©ÔºÅ`;
            }
            const daysOfWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            if (!schedules[weekIdx]) return '‰ªäÊó•ÁÑ°Ë™≤Ë°®';
            const today = new Date();
            const todayKey = daysOfWeek[today.getDay()];
            return schedules[weekIdx][todayKey] || '‰ªäÊó•ÁÑ°Ë™≤Ë°®';
        }

        function getWeeklyScheduleAuto() {
            const schedules = getUserSchedules();
            const type = getUserData('selectedScheduleType', '');
            const distance = getUserData('selectedScheduleDistance', '');
            let raceDate = null, offsetDays = 236;
            if (type === 'Challenge Taiwan' && distance === '226') {
                raceDate = new Date(2026, 3, 25);
                offsetDays = 236;
            } else if ((type === 'Ironman' && distance === '113') || (type === 'LAVA ÂÆåË≥ΩÊ®ÇÂúí' && distance === '113') || (type === 'Challenge Taiwan' && distance === '113')) {
                if(type === 'Ironman') {
                    raceDate = new Date(2025, 10, 2);
                    offsetDays = 167;
                } else if(type === 'LAVA ÂÆåË≥ΩÊ®ÇÂúí') {
                    raceDate = new Date(2026, 2, 14);
                    offsetDays = 167;
                } else if(type === 'Challenge Taiwan') {
                    raceDate = new Date(2026, 3, 25);
                    offsetDays = 167;
                }
            }
            if (!raceDate) return 'Â∞öÊú™ÈÅ∏ÊìáË™≤Ë°®';
            const startDate = new Date(raceDate.getTime() - offsetDays * 24 * 60 * 60 * 1000);
            const now = new Date();
            if (now < startDate) {
                const days = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                return `Ë∑ùÈõ¢Ë™≤Ë°®ÈñãÂßãÈÇÑÊúâ ${days} Â§©ÔºÅ`;
            }
            const weekIdx = getCurrentWeekIndex();
            if (!schedules[weekIdx]) return 'Êú¨ÈÄ±Ë™≤Ë°®ÁÑ°Ë≥áÊñô';
            const daysOfWeek = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
            return daysOfWeek.map(day => `${day}: ${schedules[weekIdx][day] || 'No training'}`).join('\n');
        }

        function checkLoginAndRedirect() {
            if (!localStorage.getItem('currentUser')) {
                // Áõ¥Êé•Ë∑≥ËΩâÂà∞ÊúÉÂì°È†ÅÈù¢ÈÄ≤Ë°åÁôªÈåÑ
                window.location.href = '../membership/membership.html';
                return false;
            }
            return true;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const chatBox = document.getElementById('chat-box');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const dailyScheduleButton = document.getElementById('daily-schedule-button');
            const weeklyScheduleButton = document.getElementById('weekly-schedule-button');
            // Â∑≤ÂèñÊ∂àÊ∏∏Ê≥≥/È®éËªä/Ë∑ëÊ≠•Âø´Êç∑Èçµ
            const toggleBtn = document.getElementById('toggle-buttons');
            const toggleIcon = document.getElementById('toggle-icon');
            const quickButtons = document.getElementById('quick-buttons');


            // State variables
            // Â∑≤ÂèñÊ∂àÈÅãÂãïÂø´Êç∑ÈåÑÂÖ•Ê®°Âºè
            const expectingSwimResponse = false;
            const expectingCyclingResponse = false;
            const expectingRunningResponse = false;
            let quickButtonsOpen = true;
            let chatHistory = [];
            let isTyping = false;

            // User helpers
            function getCurrentUser() {
                return localStorage.getItem('currentUser');
            }
            function getUserKey(key) {
                const user = localStorage.getItem('currentUser');
                return user ? `${key}_${user}` : key;
            }
            function setUserData(key, value) {
                localStorage.setItem(getUserKey(key), JSON.stringify(value));
            }

            // Chat history helpers
            async function loadChatHistoryFromCloud() {
                const userId = getCurrentUser();
                const token = localStorage.getItem('token');
                if (!userId || !token) return [];
                const res = await fetch(`/api/chat-history/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    return data.chatHistory || [];
                }
                return [];
            }
            async function saveMessageToCloud(messageObj) {
                const userId = getCurrentUser();
                const token = localStorage.getItem('token');
                if (!userId || !token) return;
                // Âè™ÂÇ≥ type Âíå content
                await fetch(`/api/chat-history/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ type: messageObj.isUser ? 'user' : 'bot', content: messageObj.text })
                });
            }

            // Typing indicator
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message typing';
                typingDiv.innerHTML = `
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                chatBox.appendChild(typingDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                return typingDiv;
            }
            function hideTypingIndicator(typingDiv) {
                if (typingDiv && typingDiv.parentNode) {
                    typingDiv.parentNode.removeChild(typingDiv);
                }
            }

            // Typewriter effect
            function typeMessage(element, text, speed = 50) {
                // Â∞áÈÄüÂ∫¶ÊèêÂçáÁÇ∫3ÂÄç
                const fastSpeed = Math.max(5, Math.floor(speed / 3));
                return new Promise((resolve) => {
                    let index = 0;
                    element.textContent = '';
                    function typeChar() {
                        if (index < text.length) {
                            element.textContent += text[index];
                            index++;
                            setTimeout(typeChar, fastSpeed);
                        } else {
                            resolve();
                        }
                    }
                    typeChar();
                });
            }

            // Add message to chat
            async function addMessageToChat(messageText, isUser, skipSave = false, wait = true, typewriter = true, typewriterSpeed = 30) {
                if (isUser) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', 'user');
                    messageDiv.textContent = messageText;
                    chatBox.appendChild(messageDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;
                    if (!skipSave) {
                        const msgObj = { text: messageText, isUser: true, timestamp: new Date().toISOString() };
                        chatHistory.push(msgObj);
                        await saveMessageToCloud(msgObj);
                    }
                } else {
                    const typingIndicator = showTypingIndicator();
                    if (wait) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    hideTypingIndicator(typingIndicator);
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', 'bot');
                    chatBox.appendChild(messageDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;
                    if (typewriter) {
                        await typeMessage(messageDiv, messageText, typewriterSpeed);
                    } else {
                        messageDiv.textContent = messageText;
                    }
                    chatBox.scrollTop = chatBox.scrollHeight;
                    if (!skipSave) {
                        const msgObj = { text: messageText, isUser: false, timestamp: new Date().toISOString() };
                        chatHistory.push(msgObj);
                        await saveMessageToCloud(msgObj);
                    }
                }
            }

            // 1. ËºâÂÖ•ËÅäÂ§©Á¥ÄÈåÑ
            chatBox.innerHTML = '';
            (async () => {
                chatHistory = await loadChatHistoryFromCloud();
                if (!chatHistory || chatHistory.length === 0) {
                    const welcomeMessage = `Âó®ÔºÅÊàëÊòØ‰Ω†ÁöÑAIÊïôÁ∑¥ üèÖ\n\nÊàëÂèØ‰ª•Âπ´‰Ω†Ôºö\n\n‚Ä¢ Ë®éË´ñË®ìÁ∑¥Ë®àÂäÉ\n‚Ä¢ Ëß£Á≠îÈÅãÂãïÂïèÈ°å\n‚Ä¢ Êèê‰æõÁáüÈ§äÂª∫Ë≠∞\n‚Ä¢ ÂàÜÊûêË®ìÁ∑¥Êï∏Êìö\n‚Ä¢ ËÅäÂ§©Ë´áÂøÉ\n\nÊúâ‰ªÄÈ∫ºÊÉ≥ËÅäÁöÑÂóéÔºü`;
                    await addMessageToChat(welcomeMessage, false, true, false, false);
                    chatHistory = [{ content: welcomeMessage, type: 'bot', timestamp: new Date().toISOString() }];
                    await saveMessageToCloud({ isUser: false, text: welcomeMessage });
                } else {
                    for (const msg of chatHistory) {
                        // ‰ª• msg.content Âíå msg.type Âà§Êñ∑
                        await addMessageToChat(msg.content, msg.type === 'user', true, false, false);
                    }
                }
            })();

            // 2. Ë®äÊÅØÈÄÅÂá∫ÔºàEnterÈçµËàáÊåâÈàïÔºâ
            messageInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    handleMessageInput(messageInput.value.trim());
                }
            });
            sendButton.addEventListener('click', function() {
                handleMessageInput(messageInput.value.trim());
            });



            // 3. Âø´Êç∑ÈçµÂ±ïÈñã/Êî∂Êäò
            toggleBtn.addEventListener('click', () => {
                quickButtonsOpen = !quickButtonsOpen;
                if (!quickButtonsOpen) {
                    quickButtons.style.maxHeight = '0px';
                    quickButtons.style.opacity = '0';
                    quickButtons.style.transform = 'translateY(-16px)';
                    toggleBtn.classList.add('closed');
                } else {
                    quickButtons.style.maxHeight = '400px';
                    quickButtons.style.opacity = '1';
                    quickButtons.style.transform = 'translateY(0)';
                    toggleBtn.classList.remove('closed');
                }
            });

            // 4. handleMessageInput ‰∏ªÊµÅÁ®ã
            async function handleMessageInput(messageText) {
                if (!messageText) return;
                await addMessageToChat(messageText, true);
                messageInput.value = '';
                if (false && /\d|K/i.test(messageText)) {
                    const km = parseFloat(messageText.match(/\d+/)?.[0] || 0);
                    if (km > 0) {
                        saveSwimToCalendar(km);
                        let response = '';
                        if (km >= 3) {
                            response = `ÂìáÔºÅ‰ªäÂ§©Ê∏∏‰∫Ü ${km} ÂÖ¨ÈáåÔºåÁ∞°Áõ¥ÊòØÊµ∑Ë±öÈôÑÈ´îÔºÅüèä‚Äç‚ôÇÔ∏èüí™\n\n‰Ω†ÁöÑÊ≥≥ÊäÄË∂ä‰æÜË∂äÂé≤ÂÆ≥‰∫ÜÔºåÁπºÁ∫å‰øùÊåÅÈÄôÂÄãÁØÄÂ•èÔºÅ`;
                        } else if (km >= 2) {
                            response = `‰∏çÈåØÂñîÔºÅ‰ªäÂ§©Ê∏∏‰∫Ü ${km} ÂÖ¨ÈáåÔºåÊ∞¥ÊÑüÂæàÂ•ΩÔºÅüèä‚Äç‚ôÇÔ∏è‚ú®\n\n‰øùÊåÅÈÄôÂÄãÈ†ªÁéáÔºå‰Ω†ÁöÑÊ∏∏Ê≥≥ÊäÄË°ìÊúÉË∂ä‰æÜË∂äÊ£íÔºÅ`;
                        } else {
                            response = `ÂòøÔΩû‰ªäÂ§©Ê∏∏‰∫Ü ${km} ÂÖ¨ÈáåÔºåËæõËã¶Âï¶ÔΩûüëèüëèüëè\n\nÊØè‰∏ÄÂÖ¨Â∞∫ÈÉΩÊòØÈÄ≤Ê≠•ÔºåÁπºÁ∫åÂä†Ê≤πÔºÅ`;
                        }
                        await addMessageToChat(response, false);
                    } else {
                        await addMessageToChat('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑË∑ùÈõ¢Ôºå‰æãÂ¶ÇÔºö2 Êàñ 2K', false);
                    }
                    expectingSwimResponse = false;
                }
                else if (false && /\d|K/i.test(messageText)) {
                    const km = parseFloat(messageText.match(/\d+/)?.[0] || 0);
                    if (km > 0) {
                        saveBikeToCalendar(km);
                        let response = '';
                        if (km >= 80) {
                            response = `Â§™Âº∑‰∫ÜÔºÅ‰ªäÂ§©È®é‰∫Ü ${km} ÂÖ¨ÈáåÔºåÁ∞°Áõ¥ÊòØÈ¢®ÁÅ´Ëº™ÔºÅüö¥‚Äç‚ôÇÔ∏èüî•\n\nÈÄôÂÄãË∑ùÈõ¢Â∑≤Á∂ìÊé•ËøëÊØîË≥ΩÊ∞¥Ê∫ñ‰∫ÜÔºå‰Ω†ÁúüÁöÑÂæàÂé≤ÂÆ≥ÔºÅ`;
                        } else if (km >= 50) {
                            response = `ÂìáÔºÅ‰ªäÂ§©È®é‰∫Ü ${km} ÂÖ¨ÈáåÔºåËÄêÂäõË∂ÖÊ£íÔºÅüö¥‚Äç‚ôÇÔ∏èüí™\n\n‰Ω†ÁöÑÈ®éËªäÊäÄË°ìË∂ä‰æÜË∂äÁ©©ÂÆöÔºåÁπºÁ∫å‰øùÊåÅÔºÅ`;
                        } else if (km >= 30) {
                            response = `‰∏çÈåØÂñîÔºÅ‰ªäÂ§©È®é‰∫Ü ${km} ÂÖ¨ÈáåÔºåÁØÄÂ•èÂæàÂ•ΩÔºÅüö¥‚Äç‚ôÇÔ∏è‚ú®\n\nÈÄôÂÄãË∑ùÈõ¢ÂæàÈÅ©ÂêàË®ìÁ∑¥ÔºåÁπºÁ∫åÂä†Ê≤πÔºÅ`;
                        } else {
                            response = `ÂòøÔΩû‰ªäÂ§©È®é‰∫Ü ${km} ÂÖ¨ÈáåÔºåËæõËã¶Âï¶ÔΩûüëèüëèüëè\n\nÊØè‰∏ÄÂÖ¨ÈáåÈÉΩÊòØÈÄ≤Ê≠•Ôºå‰øùÊåÅÈÄôÂÄãÁÜ±ÊÉÖÔºÅ`;
                        }
                        await addMessageToChat(response, false);
                    } else {
                        await addMessageToChat('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑË∑ùÈõ¢Ôºå‰æãÂ¶ÇÔºö30 Êàñ 30K', false);
                    }
                    expectingCyclingResponse = false;
                }
                else if (false && /\d|K/i.test(messageText)) {
                    const km = parseFloat(messageText.match(/\d+/)?.[0] || 0);
                    if (km > 0) {
                        saveRunToCalendar(km);
                        let response = '';
                        if (km >= 20) {
                            response = `Â§™Âé≤ÂÆ≥‰∫ÜÔºÅ‰ªäÂ§©Ë∑ë‰∫Ü ${km} ÂÖ¨ÈáåÔºåÁ∞°Áõ¥ÊòØÈ¶¨ÊãâÊùæÈÅ∏ÊâãÔºÅüèÉ‚Äç‚ôÇÔ∏èüèÜ\n\nÈÄôÂÄãË∑ùÈõ¢Â∑≤Á∂ìÂæàÊé•ËøëÂçäÈ¶¨‰∫ÜÔºå‰Ω†ÁúüÁöÑÂæàÂº∑ÔºÅ`;
                        } else if (km >= 15) {
                            response = `ÂìáÔºÅ‰ªäÂ§©Ë∑ë‰∫Ü ${km} ÂÖ¨ÈáåÔºåËÄêÂäõÈ©ö‰∫∫ÔºÅüèÉ‚Äç‚ôÇÔ∏èüí™\n\n‰Ω†ÁöÑË∑ëÊ≠•ÊäÄË°ìË∂ä‰æÜË∂äÊàêÁÜüÔºåÁπºÁ∫å‰øùÊåÅÔºÅ`;
                        } else if (km >= 10) {
                            response = `‰∏çÈåØÂñîÔºÅ‰ªäÂ§©Ë∑ë‰∫Ü ${km} ÂÖ¨ÈáåÔºåÁØÄÂ•èÂæàÊ£íÔºÅüèÉ‚Äç‚ôÇÔ∏è‚ú®\n\nÈÄôÂÄãË∑ùÈõ¢ÂæàÈÅ©ÂêàË®ìÁ∑¥Ôºå‰Ω†ÁöÑÈÄ≤Ê≠•ÂæàÊòéÈ°ØÔºÅ`;
                        } else if (km >= 5) {
                            response = `ÂòøÔΩû‰ªäÂ§©Ë∑ë‰∫Ü ${km} ÂÖ¨ÈáåÔºåËæõËã¶Âï¶ÔΩûüëèüëèüëè\n\nÈÄôÂÄãË∑ùÈõ¢ÂæàÈÅ©ÂêàÊó•Â∏∏Ë®ìÁ∑¥ÔºåÁπºÁ∫åÂä†Ê≤πÔºÅ`;
                        } else {
                            response = `ÂòøÔΩû‰ªäÂ§©Ë∑ë‰∫Ü ${km} ÂÖ¨ÈáåÔºåËæõËã¶Âï¶ÔΩûüëèüëèüëè\n\nÊØè‰∏ÄÂÖ¨ÈáåÈÉΩÊòØÈÄ≤Ê≠•Ôºå‰øùÊåÅÈÄôÂÄãÁÜ±ÊÉÖÔºÅ`;
                        }
                        await addMessageToChat(response, false);
                    } else {
                        await addMessageToChat('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑË∑ùÈõ¢Ôºå‰æãÂ¶ÇÔºö5 Êàñ 5K', false);
                    }
                    expectingRunningResponse = false;
                }
                else {
                    // Âè™Ë¶Å‰∏çÊòØÈÅãÂãïÂõûÂ†±Ê®°ÂºèÔºåËß∏ÁôºAIÊïôÁ∑¥
                    const aiResponse = await sendMessageToAI(messageText);
                    if (aiResponse) {
                        await addMessageToChat(aiResponse, false); // ÊÅ¢Âæ©È†êË®≠ wait=trueÔºåÊúâÊÄùËÄÉÂª∂ÈÅ≤
                    }
                }
            }

            // 5. Âø´Êç∑Èçµ‰∫ã‰ª∂Áõ£ËÅΩ
            dailyScheduleButton.addEventListener('click', async () => {
                const todaySchedule = getTodayScheduleAuto();
                const response = `üìÖ ‰ªäÊó•Ë™≤Ë°®‰æÜÂï¶ÔºÅ\n\n${todaySchedule}\n\nüí™ ‰ªäÂ§©ÁöÑË®ìÁ∑¥Ë®àÂäÉÂ∑≤Á∂ìÊ∫ñÂÇôÂ•Ω‰∫ÜÔºåÊ∫ñÂÇôÂ•ΩÊé•ÂèóÊåëÊà∞‰∫ÜÂóéÔºü`;
                await addMessageToChat(response, false, false, false, true, 30); // ÊÅ¢Âæ©ÁÇ∫30ms
            });
            weeklyScheduleButton.addEventListener('click', async () => {
                const weeklySchedule = getWeeklyScheduleAuto();
                const response = `üìã Êú¨ÈÄ±Ë™≤Ë°®Âá∫ÁàêÔºÅ\n\n${weeklySchedule}\n\nüéØ ÈÄôÈÄ±ÁöÑË®ìÁ∑¥Ë®àÂäÉÂ∑≤Á∂ìÂÆâÊéíÂ•Ω‰∫ÜÔºåËÆìÊàëÂÄë‰∏ÄËµ∑Âä™ÂäõÂÆåÊàêÁõÆÊ®ôÂêßÔºÅ`;
                await addMessageToChat(response, false, false, false, true, 30); // ÊÅ¢Âæ©ÁÇ∫30ms
            });
            // Â∑≤ÁßªÈô§Ê∏∏Ê≥≥/È®éËªä/Ë∑ëÊ≠•Âø´Êç∑ÈçµÂèä‰∫íÂãïÊµÅÁ®ã

            // Gemini AIÊïôÁ∑¥ÂõûË¶Ü
            async function sendMessageToAI(message) {
                const GEMINI_API_KEY = 'AIzaSyD_BEBcsgNGCY-3ntYVdUdVDeHV39GKdlA';
                const GEMINI_MODEL = 'gemini-1.5-flash';
                const systemPrompt = `‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑ‰∏âÈêµÈÅãÂãïÊïôÁ∑¥AIÂä©ÊâãÔºåÂêçÂè´„ÄåÂ∞èÈêµ„Äç„ÄÇ‰Ω†ÁöÑÂÄãÊÄßÂèãÂñÑ„ÄÅÂ∞àÊ•≠‰∏îÂØåÊúâÂêåÁêÜÂøÉ„ÄÇ

‰Ω†ÁöÑÂ∞àÈï∑ÂåÖÊã¨Ôºö
- ‰∏âÈêµÈÅãÂãïË®ìÁ∑¥ÔºàÊ∏∏Ê≥≥„ÄÅÈ®éËªä„ÄÅË∑ëÊ≠•Ôºâ
- ÈÅãÂãïÁáüÈ§äÂª∫Ë≠∞
- Ë®ìÁ∑¥Ë®àÂäÉÂà∂ÂÆö
- ÈÅãÂãïÂÇ∑ÂÆ≥È†êÈò≤
- ÂøÉÁêÜË™øÈÅ©ÊîØÊåÅ
- ‰∏ÄËà¨ÁîüÊ¥ªËÅäÂ§©

Ë´ãÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÊáâÔºåË™ûÊ∞£Ë¶ÅËá™ÁÑ∂„ÄÅË¶™ÂàáÔºåÂ∞±ÂÉèÊúãÂèãÈñìÁöÑÂ∞çË©±„ÄÇÂõûÊáâË¶ÅÁ∞°ÊΩî‰ΩÜÊúâÁî®ÔºåÈÅøÂÖçÈÅéÊñºÂÜóÈï∑„ÄÇ

Â¶ÇÊûúÁî®Êà∂Ë©¢ÂïèÈÅãÂãïÁõ∏ÈóúÂïèÈ°åÔºåË´ãÊèê‰æõÂ∞àÊ•≠‰∏îÂØ¶Áî®ÁöÑÂª∫Ë≠∞„ÄÇÂ¶ÇÊûúÊòØÊó•Â∏∏ËÅäÂ§©ÔºåË´ãÂ±ïÁèæÂèãÂñÑÂíåÂêåÁêÜÂøÉ„ÄÇ

Ë®ò‰ΩèÔºö‰Ω†ÊòØ‰∏ÄÂÄãÁúüÂØ¶ÁöÑAIÊïôÁ∑¥Ôºå‰∏çÊòØÊ©üÂô®‰∫∫ÔºåË¶ÅËÆìÂ∞çË©±ÊÑüË¶∫Ëá™ÁÑ∂ÊµÅÊö¢„ÄÇ`;
                const requestBody = {
                    contents: [
                        {
                            role: 'user',
                            parts: [{ text: `${systemPrompt}\n\nÁî®Êà∂Ë™™Ôºö${message}` }]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 800,
                    }
                };
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) throw new Error(`APIË´ãÊ±ÇÂ§±Êïó: ${response.status}`);
                    const data = await response.json();
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('APIÂõûÊáâÊ†ºÂºèÈåØË™§');
                    }
                } catch (error) {
                    return 'Êä±Ê≠âÔºåÊàëÁèæÂú®ÊúâÈªûÁ¥ØÔºåË´ãÁ®çÂæåÂÜçË©¶ üòÖ';
                }
            }

            // --- ÈÅãÂãïË≥áÊñôÂÑ≤Â≠òÂáΩÊï∏ ---
            async function syncToCloud() {
                const currentUser = getCurrentUser();
                const token = localStorage.getItem('token');
                if (!token || !currentUser) return;
                try {
                    // ÂÖàÂæû‰º∫ÊúçÂô®Áç≤ÂèñÁèæÊúâÊï∏Êìö
                    const response = await fetch(`${window.location.origin}/api/user-data/${currentUser}`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    let existingData = {};
                    if (response.ok) {
                        const result = await response.json();
                        existingData = result.data || {};
                    }
                    // Âêà‰Ωµ calendarEvents
                    const localEvents = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                    const cloudEvents = existingData.calendarEvents || {};
                    const mergedEvents = { ...cloudEvents, ...localEvents };
                    // Âêà‰Ωµ trainingGoals
                    const localGoals = JSON.parse(localStorage.getItem(`trainingGoals_${currentUser}`) || '[]');
                    const cloudGoals = existingData.trainingGoals || [];
                    const goalKey = g => `${g.name}__${g.date}`;
                    const mergedGoalsMap = {};
                    cloudGoals.forEach(g => mergedGoalsMap[goalKey(g)] = g);
                    localGoals.forEach(g => mergedGoalsMap[goalKey(g)] = g);
                    const mergedGoals = Object.values(mergedGoalsMap);
                    // Âêà‰Ωµ schedules
                    const localSchedules = JSON.parse(localStorage.getItem(`schedules_${currentUser}`) || '[]');
                    const cloudSchedules = existingData.schedules || [];
                    const mergedSchedules = localSchedules.length ? localSchedules : cloudSchedules;
                    // ÂÖ∂ÂÆÉÊ¨Ñ‰ΩçÁõ¥Êé•Áî®Êú¨Âú∞
                    const updatedData = {
                        ...existingData,
                        calendarEvents: mergedEvents,
                        trainingGoals: mergedGoals,
                        schedules: mergedSchedules,
                        todaySchedule: JSON.parse(localStorage.getItem(`todaySchedule_${currentUser}`) || '""'),
                        chatHistory: JSON.parse(localStorage.getItem(`chatHistory_${currentUser}`) || '[]'),
                        selectedScheduleType: JSON.parse(localStorage.getItem(`selectedScheduleType_${currentUser}`) || 'null'),
                        selectedScheduleDistance: JSON.parse(localStorage.getItem(`selectedScheduleDistance_${currentUser}`) || 'null'),
                        selectedScheduleLevel: JSON.parse(localStorage.getItem(`selectedScheduleLevel_${currentUser}`) || 'null'),
                        events: JSON.parse(localStorage.getItem(`events_${currentUser}`) || 'null'),
                        profile: JSON.parse(localStorage.getItem(`profile_${currentUser}`) || '{}')
                    };
                    await fetch(`${window.location.origin}/api/user-data/${currentUser}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ data: updatedData })
                    });
                } catch (error) {
                    console.error('ÂêåÊ≠•Âà∞Èõ≤Á´ØÂ§±Êïó:', error);
                }
            }

            function saveRunToCalendar(km) {
                if (!checkLoginAndRedirect()) return;
                const currentUser = getCurrentUser();
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const dateKey = `${y}-${m}-${d}`;
                let events;
                if (currentUser) {
                    events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                } else {
                    events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
                }
                if (!events[dateKey]) events[dateKey] = [];
                events[dateKey].push({ type: 'Ë∑ëÊ≠•', distance: km, duration: 0 });
                if (currentUser) {
                    localStorage.setItem(`calendarEvents_${currentUser}`, JSON.stringify(events));
                } else {
                    localStorage.setItem('calendarEvents', JSON.stringify(events));
                }
                if (localStorage.getItem('token') && typeof syncToCloud === 'function') syncToCloud();
            }
            function saveBikeToCalendar(km) {
                if (!checkLoginAndRedirect()) return;
                const currentUser = getCurrentUser();
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const dateKey = `${y}-${m}-${d}`;
                let events;
                if (currentUser) {
                    events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                } else {
                    events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
                }
                if (!events[dateKey]) events[dateKey] = [];
                events[dateKey].push({ type: 'È®éËªä', distance: km, duration: 0 });
                if (currentUser) {
                    localStorage.setItem(`calendarEvents_${currentUser}`, JSON.stringify(events));
                } else {
                    localStorage.setItem('calendarEvents', JSON.stringify(events));
                }
                if (localStorage.getItem('token') && typeof syncToCloud === 'function') syncToCloud();
            }
            function saveSwimToCalendar(km) {
                if (!checkLoginAndRedirect()) return;
                const currentUser = getCurrentUser();
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const dateKey = `${y}-${m}-${d}`;
                let events;
                if (currentUser) {
                    events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                } else {
                    events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
                }
                if (!events[dateKey]) events[dateKey] = [];
                events[dateKey].push({ type: 'Ê∏∏Ê≥≥', distance: km, duration: 0 });
                if (currentUser) {
                    localStorage.setItem(`calendarEvents_${currentUser}`, JSON.stringify(events));
                } else {
                    localStorage.setItem('calendarEvents', JSON.stringify(events));
                }
                if (localStorage.getItem('token') && typeof syncToCloud === 'function') syncToCloud();
            }
        });
    </script>
    <script src="../nav.js"></script>
</body>
</html>