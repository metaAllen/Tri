<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¼·åˆ¶ä¿®å¾© Strava åŒæ­¥å•é¡Œ</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      background: #f8f9fa;
      max-width: 800px;
      margin: 0 auto;
    }
    .fix-section { 
      background: white; 
      padding: 20px; 
      margin: 20px 0; 
      border: 1px solid #ddd; 
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .fix-section h3 { 
      color: #dc3545; 
      border-bottom: 2px solid #dc3545; 
      padding-bottom: 10px; 
    }
    .warning { 
      background: #fff3cd; 
      border: 1px solid #ffeaa7; 
      color: #856404; 
      padding: 15px; 
      border-radius: 5px; 
      margin: 15px 0;
    }
    .success { 
      background: #d4edda; 
      border: 1px solid #c3e6cb; 
      color: #155724; 
      padding: 15px; 
      border-radius: 5px; 
      margin: 15px 0;
    }
    .error { 
      background: #f8d7da; 
      border: 1px solid #f5c6cb; 
      color: #721c24; 
      padding: 15px; 
      border-radius: 5px; 
      margin: 15px 0;
    }
    button { 
      padding: 12px 20px; 
      margin: 10px 5px; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-size: 16px;
      font-weight: bold;
    }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-warning { background: #ffc107; color: black; }
    .btn-warning:hover { background: #e0a800; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .log { 
      background: #f8f9fa; 
      border: 1px solid #dee2e6; 
      border-radius: 5px; 
      padding: 15px; 
      margin: 15px 0; 
      font-family: monospace; 
      white-space: pre-wrap; 
      max-height: 400px; 
      overflow-y: auto; 
    }
    .status-box {
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸš¨ Strava åŒæ­¥å•é¡Œå¼·åˆ¶ä¿®å¾©å·¥å…·</h1>
  
  <div class="warning">
    <strong>âš ï¸ è­¦å‘Šï¼š</strong> æ­¤å·¥å…·æœƒæ¸…é™¤æ‰€æœ‰ Strava ç›¸é—œçš„æœ¬åœ°æ•¸æ“šï¼Œä¸¦å¼·åˆ¶é‡æ–°æˆæ¬Šã€‚è«‹ç¢ºä¿ä½ å·²å‚™ä»½é‡è¦æ•¸æ“šã€‚
  </div>

  <div class="fix-section">
    <h3>1. ç•¶å‰å•é¡Œè¨ºæ–·</h3>
    <button class="btn-primary" onclick="diagnoseProblem()">è¨ºæ–·å•é¡Œ</button>
    <div id="diagnosis"></div>
  </div>

  <div class="fix-section">
    <h3>2. å¼·åˆ¶æ¸…é™¤ Strava æ•¸æ“š</h3>
    <button class="btn-danger" onclick="clearStravaData()">æ¸…é™¤æ‰€æœ‰ Strava æ•¸æ“š</button>
    <div id="clearStatus"></div>
  </div>

  <div class="fix-section">
    <h3>3. å¼·åˆ¶é‡æ–°æˆæ¬Š</h3>
    <button class="btn-warning" onclick="forceReauthorize()">å¼·åˆ¶é‡æ–°æˆæ¬Š Strava</button>
    <div id="authStatus"></div>
  </div>

  <div class="fix-section">
    <h3>4. æ¸¬è©¦ä¿®å¾©çµæœ</h3>
    <button class="btn-success" onclick="testFix()">æ¸¬è©¦ä¿®å¾©çµæœ</button>
    <div id="testStatus"></div>
  </div>

  <div class="fix-section">
    <h3>5. æ“ä½œæ—¥èªŒ</h3>
    <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    <div id="fixLog" class="log"></div>
  </div>

  <script src="../auth.js"></script>
  <script>
    let logContent = '';

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}\n`;
      logContent += logEntry;
      document.getElementById('fixLog').textContent = logContent;
      console.log(message);
    }

    function clearLog() {
      logContent = '';
      document.getElementById('fixLog').textContent = '';
    }

    function showStatus(elementId, message, type = 'success') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status-box ${type}">${message}</div>`;
    }

    // 1. è¨ºæ–·å•é¡Œ
    async function diagnoseProblem() {
      log('é–‹å§‹è¨ºæ–· Strava åŒæ­¥å•é¡Œ...');
      
      const currentUser = localStorage.getItem('currentUser');
      const username = localStorage.getItem('username');
      const token = localStorage.getItem('token');
      const stravaSyncEnabled = localStorage.getItem('stravaSyncEnabled');
      const stravaAccessToken = localStorage.getItem('strava_access_token');
      const stravaRefreshToken = localStorage.getItem('strava_refresh_token');
      const stravaExpiresAt = localStorage.getItem('strava_expires_at');
      
      let diagnosis = `
        <strong>åŸºæœ¬èªè­‰ç‹€æ…‹ï¼š</strong><br>
        - ç•¶å‰ç”¨æˆ¶: ${currentUser || 'æœªè¨­ç½®'}<br>
        - ç”¨æˆ¶å: ${username || 'æœªè¨­ç½®'}<br>
        - èªè­‰ Token: ${token ? 'å·²è¨­ç½®' : 'æœªè¨­ç½®'}<br>
        - Strava åŒæ­¥å•Ÿç”¨: ${stravaSyncEnabled || 'æœªè¨­ç½®'}<br><br>
        
        <strong>Strava Token ç‹€æ…‹ï¼š</strong><br>
        - Access Token: ${stravaAccessToken ? 'å·²è¨­ç½®' : 'æœªè¨­ç½®'}<br>
        - Refresh Token: ${stravaRefreshToken ? 'å·²è¨­ç½®' : 'æœªè¨­ç½®'}<br>
        - éæœŸæ™‚é–“: ${stravaExpiresAt ? new Date(stravaExpiresAt * 1000).toLocaleString() : 'æœªè¨­ç½®'}<br>
      `;

      if (window.tokenManager) {
        try {
          const isExpired = window.tokenManager.isTokenExpired();
          diagnosis += `<br><strong>Token æœ‰æ•ˆæ€§æª¢æŸ¥ï¼š</strong><br>`;
          diagnosis += `- Token ç‹€æ…‹: ${isExpired ? '<span style="color: red;">å·²éæœŸ</span>' : '<span style="color: green;">æœ‰æ•ˆ</span>'}`;
          
          if (isExpired) {
            diagnosis += '<br><span style="color: red;">âœ— ä¸»è¦å•é¡Œï¼šStrava Token å·²éæœŸ</span>';
          }
        } catch (error) {
          diagnosis += `<br><span style="color: red;">âœ— Token æª¢æŸ¥å¤±æ•—: ${error.message}</span>`;
        }
      } else {
        diagnosis += '<br><span style="color: red;">âœ— tokenManager æœªè¼‰å…¥</span>';
      }

      // æª¢æŸ¥é›²ç«¯ç‹€æ…‹
      if (currentUser && token) {
        try {
          const response = await fetch('/api/user-data', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const userData = await response.json();
            const cloudStravaSync = userData.stravaSync && userData.stravaSync.enabled;
            
            diagnosis += `<br><br><strong>é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼š</strong><br>`;
            diagnosis += `- é›²ç«¯åŒæ­¥å•Ÿç”¨: ${cloudStravaSync ? 'æ˜¯' : 'å¦'}`;
            
            if (stravaSyncEnabled !== cloudStravaSync) {
              diagnosis += '<br><span style="color: orange;">âš  æœ¬åœ°èˆ‡é›²ç«¯ç‹€æ…‹ä¸ä¸€è‡´</span>';
            }
          }
        } catch (error) {
          diagnosis += `<br><span style="color: red;">âœ— ç„¡æ³•æª¢æŸ¥é›²ç«¯ç‹€æ…‹: ${error.message}</span>`;
        }
      }

      showStatus('diagnosis', diagnosis);
      log('å•é¡Œè¨ºæ–·å®Œæˆ');
    }

    // 2. æ¸…é™¤ Strava æ•¸æ“š
    function clearStravaData() {
      log('é–‹å§‹æ¸…é™¤ Strava æ•¸æ“š...');
      
      // æ¸…é™¤ localStorage ä¸­çš„ Strava ç›¸é—œæ•¸æ“š
      localStorage.removeItem('strava_access_token');
      localStorage.removeItem('strava_refresh_token');
      localStorage.removeItem('strava_expires_at');
      localStorage.removeItem('stravaSyncEnabled');
      
      // æ¸…é™¤æ—¥æ›†äº‹ä»¶ä¸­çš„ Strava æ´»å‹•
      const currentUser = localStorage.getItem('currentUser');
      if (currentUser) {
        let events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
        let hasStravaEvents = false;
        
        Object.keys(events).forEach(date => {
          events[date] = events[date].filter(event => {
            if (event.source === 'Strava') {
              hasStravaEvents = true;
              return false; // ç§»é™¤ Strava æ´»å‹•
            }
            return true;
          });
        });
        
        localStorage.setItem(`calendarEvents_${currentUser}`, JSON.stringify(events));
        
        if (hasStravaEvents) {
          log('å·²æ¸…é™¤æ—¥æ›†ä¸­çš„ Strava æ´»å‹•');
        }
      }
      
      // æ¸…é™¤é›²ç«¯åŒæ­¥ç‹€æ…‹
      updateCloudSyncStatus(false);
      
      showStatus('clearStatus', `
        <strong style="color: green;">âœ“ Strava æ•¸æ“šæ¸…é™¤å®Œæˆ</strong><br>
        - æœ¬åœ° Token å·²æ¸…é™¤<br>
        - æ—¥æ›† Strava æ´»å‹•å·²æ¸…é™¤<br>
        - åŒæ­¥ç‹€æ…‹å·²é‡ç½®
      `, 'success');
      
      log('Strava æ•¸æ“šæ¸…é™¤å®Œæˆ');
    }

    // 3. å¼·åˆ¶é‡æ–°æˆæ¬Š
    async function forceReauthorize() {
      log('é–‹å§‹å¼·åˆ¶é‡æ–°æˆæ¬Š Strava...');
      
      try {
        const response = await fetch('/api/strava/auth');
        const data = await response.json();
        
        if (data.url) {
          showStatus('authStatus', `
            <strong style="color: blue;">æ­£åœ¨è·³è½‰åˆ° Strava æˆæ¬Šé é¢...</strong><br>
            è«‹åœ¨ Strava é é¢å®Œæˆæˆæ¬Šå¾Œè¿”å›
          `, 'info');
          
          log('è·³è½‰åˆ° Strava æˆæ¬Šé é¢');
          setTimeout(() => {
            window.location.href = data.url;
          }, 2000);
        } else {
          showStatus('authStatus', `
            <strong style="color: red;">âœ— ç„¡æ³•ç²å– Strava æˆæ¬Šç¶²å€</strong><br>
            éŒ¯èª¤: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}
          `, 'error');
          log('ç„¡æ³•ç²å– Strava æˆæ¬Šç¶²å€');
        }
      } catch (error) {
        showStatus('authStatus', `
          <strong style="color: red;">âœ— æˆæ¬Šè«‹æ±‚å¤±æ•—</strong><br>
          éŒ¯èª¤: ${error.message}
        `, 'error');
        log(`æˆæ¬Šè«‹æ±‚å¤±æ•—: ${error.message}`);
      }
    }

    // 4. æ¸¬è©¦ä¿®å¾©çµæœ
    async function testFix() {
      log('é–‹å§‹æ¸¬è©¦ä¿®å¾©çµæœ...');
      
      const stravaAccessToken = localStorage.getItem('strava_access_token');
      const stravaRefreshToken = localStorage.getItem('strava_refresh_token');
      const stravaExpiresAt = localStorage.getItem('strava_expires_at');
      
      if (!stravaAccessToken || !stravaRefreshToken) {
        showStatus('testStatus', `
          <strong style="color: red;">âœ— ä¿®å¾©å¤±æ•—</strong><br>
          Strava Token ä»æœªè¨­ç½®ï¼Œè«‹å…ˆå®Œæˆé‡æ–°æˆæ¬Š
        `, 'error');
        log('ä¿®å¾©å¤±æ•—ï¼šToken ä»æœªè¨­ç½®');
        return;
      }
      
      try {
        // æ¸¬è©¦ token æœ‰æ•ˆæ€§
        if (window.tokenManager) {
          const isExpired = window.tokenManager.isTokenExpired();
          
          if (!isExpired) {
            // æ¸¬è©¦ API èª¿ç”¨
            const token = localStorage.getItem('token');
            const response = await fetch('/api/strava/activities', {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              const activityCount = data.activities ? data.activities.length : 0;
              
              showStatus('testStatus', `
                <strong style="color: green;">âœ“ ä¿®å¾©æˆåŠŸï¼</strong><br>
                - Strava Token æœ‰æ•ˆ<br>
                - API èª¿ç”¨æˆåŠŸ<br>
                - ç²å–åˆ° ${activityCount} å€‹æ´»å‹•
              `, 'success');
              
              log(`ä¿®å¾©æˆåŠŸï¼API èª¿ç”¨æˆåŠŸï¼Œæ´»å‹•æ•¸é‡: ${activityCount}`);
            } else {
              showStatus('testStatus', `
                <strong style="color: orange;">âš  éƒ¨åˆ†ä¿®å¾©</strong><br>
                - Strava Token æœ‰æ•ˆ<br>
                - ä½† API èª¿ç”¨å¤±æ•—: ${response.status}
              `, 'warning');
              
              log(`éƒ¨åˆ†ä¿®å¾©ï¼šToken æœ‰æ•ˆä½† API èª¿ç”¨å¤±æ•—`);
            }
          } else {
            showStatus('testStatus', `
              <strong style="color: red;">âœ— ä¿®å¾©å¤±æ•—</strong><br>
              Strava Token ä»ç„¶éæœŸ
            `, 'error');
            
            log('ä¿®å¾©å¤±æ•—ï¼šToken ä»ç„¶éæœŸ');
          }
        } else {
          showStatus('testStatus', `
            <strong style="color: red;">âœ— ä¿®å¾©å¤±æ•—</strong><br>
            tokenManager æœªè¼‰å…¥
          `, 'error');
          
          log('ä¿®å¾©å¤±æ•—ï¼štokenManager æœªè¼‰å…¥');
        }
      } catch (error) {
        showStatus('testStatus', `
          <strong style="color: red;">âœ— æ¸¬è©¦å¤±æ•—</strong><br>
          éŒ¯èª¤: ${error.message}
        `, 'error');
        
        log(`æ¸¬è©¦å¤±æ•—: ${error.message}`);
      }
    }

    // æ›´æ–°é›²ç«¯åŒæ­¥ç‹€æ…‹
    async function updateCloudSyncStatus(enabled) {
      const userId = localStorage.getItem('currentUser');
      const token = localStorage.getItem('token');
      
      if (userId && token) {
        try {
          await fetch('/api/strava/update-sync-status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ stravaSyncEnabled: enabled })
          });
          log(`é›²ç«¯åŒæ­¥ç‹€æ…‹å·²æ›´æ–°: ${enabled}`);
        } catch (error) {
          log(`æ›´æ–°é›²ç«¯åŒæ­¥ç‹€æ…‹å¤±æ•—: ${error.message}`);
        }
      }
    }

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¨ºæ–·
    document.addEventListener('DOMContentLoaded', () => {
      log('å¼·åˆ¶ä¿®å¾©å·¥å…·å·²è¼‰å…¥');
      setTimeout(() => {
        diagnoseProblem();
      }, 1000);
    });
  </script>
</body>
</html>
